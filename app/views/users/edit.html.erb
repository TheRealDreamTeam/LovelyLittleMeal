<div class="d-flex flex-column flex-lg-row p-4 gap-4" style="height: 100%; min-height: 0;">
  <div class="flex-grow-1 d-flex flex-column bg-white overflow-hidden" style="min-height: 0; border-radius: 12px;">
    <h2 class="mb-4 px-3 pt-3">Settings</h2>
    <div class="overflow-y-auto flex-grow-1 px-3 pb-3" style="min-height: 0;" data-controller="settings" data-settings-save-url-value="<%= settings_path %>" data-settings-gender-value="<%= @user.gender %>">

    <%= form_with model: @user, url: "/settings", method: :patch, data: { turbo: false } do |f| %>

      <!-- Physical Information Section (First) -->
      <div class="mb-4">
        <h5 class="mb-3">Physical Information</h5>
        <p class="text-muted small mb-3">This information allows to calculate your BMI, BMR, and TDEE, and tailor recipes to your needs.</p>

        <div class="row g-3">
          <!-- Age -->
          <div class="col-12 col-md-4">
            <%= f.label :age, "Age", class: "form-label" %>
            <%= f.number_field :age,
                  class: "form-control",
                  placeholder: "E.g. 32",
                  min: 1,
                  max: 150,
                  style: "border-radius: 12px; height: 38px;" %>
          </div>

          <!-- Weight -->
          <div class="col-12 col-md-4">
            <%= f.label :weight, "Weight (kg)", class: "form-label" %>
            <%= f.number_field :weight,
                  class: "form-control",
                  placeholder: "E.g. 68",
                  min: 1,
                  max: 500,
                  step: 0.1,
                  style: "border-radius: 12px; height: 38px;" %>
          </div>

          <!-- Height -->
          <div class="col-12 col-md-4">
            <%= f.label :height, "Height (cm)", class: "form-label" %>
            <%= f.number_field :height,
                  class: "form-control",
                  placeholder: "E.g. 175",
                  min: 50,
                  max: 250,
                  style: "border-radius: 12px; height: 38px;" %>
          </div>
        </div>

        <!-- Gender -->
        <div class="mt-3">
          <%= f.label :gender, "Gender", class: "form-label" %>
          <div class="d-flex flex-wrap gap-3">
            <div class="form-check">
              <%= f.radio_button :gender, "male",
                    id: "user_gender_male",
                    class: "form-check-input" %>
              <%= label_tag "user_gender_male", "Male", class: "form-check-label" %>
            </div>

            <div class="form-check">
              <%= f.radio_button :gender, "female",
                    id: "user_gender_female",
                    class: "form-check-input" %>
              <%= label_tag "user_gender_female", "Female", class: "form-check-label" %>
            </div>

            <div class="form-check">
              <%= f.radio_button :gender, "prefer_not_to_say",
                    id: "user_gender_prefer_not_to_say",
                    class: "form-check-input" %>
              <%= label_tag "user_gender_prefer_not_to_say", "Prefer not to say", class: "form-check-label" %>
            </div>
          </div>
        </div>

        <!-- Activity Level and Goal (Side by Side) -->
        <div class="row g-4 mt-4">
          <!-- Activity Level -->
          <div class="col-12 col-lg-6">
            <%= f.label :activity_level, "Activity Level", class: "form-label" %>
            <div class="d-flex flex-column gap-2">
              <div class="form-check">
                <%= f.radio_button :activity_level, "sedentary",
                      id: "user_activity_level_sedentary",
                      class: "form-check-input" %>
                <%= label_tag "user_activity_level_sedentary", "Sedentary (little or no exercise)", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :activity_level, "lightly_active",
                      id: "user_activity_level_lightly_active",
                      class: "form-check-input" %>
                <%= label_tag "user_activity_level_lightly_active", "Lightly active (light exercise 1-3 days/week)", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :activity_level, "moderately_active",
                      id: "user_activity_level_moderately_active",
                      class: "form-check-input" %>
                <%= label_tag "user_activity_level_moderately_active", "Moderately active (moderate exercise 3-5 days/week)", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :activity_level, "very_active",
                      id: "user_activity_level_very_active",
                      class: "form-check-input" %>
                <%= label_tag "user_activity_level_very_active", "Very active (hard exercise 6-7 days/week)", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :activity_level, "extra_active",
                      id: "user_activity_level_extra_active",
                      class: "form-check-input" %>
                <%= label_tag "user_activity_level_extra_active", "Extra active (very hard exercise, physical job)", class: "form-check-label" %>
              </div>
            </div>
          </div>

          <!-- Goal -->
          <div class="col-12 col-lg-6">
            <%= f.label :goal, "Fitness Goal", class: "form-label" %>
            <div class="d-flex flex-column gap-2">
              <div class="form-check">
                <%= f.radio_button :goal, "lose_weight",
                      id: "user_goal_lose_weight",
                      class: "form-check-input" %>
                <%= label_tag "user_goal_lose_weight", "Lose weight", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :goal, "maintain_weight",
                      id: "user_goal_maintain_weight",
                      class: "form-check-input" %>
                <%= label_tag "user_goal_maintain_weight", "Maintain weight", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :goal, "gain_weight",
                      id: "user_goal_gain_weight",
                      class: "form-check-input" %>
                <%= label_tag "user_goal_gain_weight", "Gain weight", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :goal, "build_muscle",
                      id: "user_goal_build_muscle",
                      class: "form-check-input" %>
                <%= label_tag "user_goal_build_muscle", "Build muscle", class: "form-check-label" %>
              </div>

              <div class="form-check">
                <%= f.radio_button :goal, "recomp",
                      id: "user_goal_recomp",
                      class: "form-check-input" %>
                <%= label_tag "user_goal_recomp", "Body recomposition (lose fat, gain muscle)", class: "form-check-label" %>
              </div>
            </div>
          </div>
        </div>

        <!-- BMI/BMR Display (always visible) -->
        <div class="mt-4 p-3 bg-light rounded">
          <h6 class="mb-3">Calculated Metrics</h6>
          
          <!-- Message shown when data is incomplete -->
          <div data-settings-target="metricsMessage" class="text-muted small mb-0">
            Fill in age, weight, and height to see calculated metrics
          </div>
          
          <!-- Metrics display -->
          <div class="row g-3" data-settings-target="metrics" style="display: none; flex-wrap: wrap;">
            <div class="col-12 col-md-4" data-settings-target="bmiContainer">
              <div>
                <strong>BMI:</strong> <span data-settings-target="bmi">-</span> 
                <span class="text-muted" data-settings-target="bmiCategory"></span>
              </div>
            </div>
            <div class="col-12 col-md-4" data-settings-target="bmrContainer">
              <div>
                <strong>BMR:</strong> <span data-settings-target="bmr">-</span> <span class="text-muted">calories/day</span>
              </div>
            </div>
            <div class="col-12 col-md-4" data-settings-target="tdeeContainer">
              <div>
                <strong>TDEE:</strong> <span data-settings-target="tdee">-</span> <span class="text-muted">calories/day</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="border-top my-4"></div>

      <!-- Allergies and Appliances Section (Side by Side) -->
      <div class="row g-4 mb-4">
        <!-- Allergies Section (Left/First) -->
        <div class="col-12 col-lg-6">
          <h5 class="mb-3">Allergies</h5>
          <p class="text-muted small mb-3">Select all allergies and intolerances. These ingredients will never appear in your recipes.</p>

          <% allergy_options = {
               "peanut" => "Peanut",
               "tree_nuts" => "Tree nuts",
               "sesame" => "Sesame",
               "shellfish" => "Shellfish",
               "milk" => "Milk",
               "egg" => "Egg",
               "fish" => "Fish",
               "wheat" => "Wheat",
               "soy" => "Soy",
               "kiwi" => "Kiwi"
             } %>

          <% # Get current allergies (handle both hash and legacy formats)
             current_allergies = if @user.allergies.is_a?(Hash)
                                   @user.allergies
                                 else
                                   # Legacy format - initialize empty hash
                                   User::STANDARD_ALLERGIES.each_with_object({}) { |a, h| h[a] = false }
                                 end %>

          <div class="d-flex flex-column gap-2">
            <% allergy_options.each do |key, label| %>
              <div class="form-check">
                <%= check_box_tag "user[allergies][#{key}]",
                                  1,
                                  current_allergies[key.to_s] == true || current_allergies[key.to_sym] == true,
                                  id: "user_allergies_#{key}",
                                  class: "form-check-input" %>
                <%= label_tag "user_allergies_#{key}",
                              label,
                              class: "form-check-label" %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Appliances Section (Right/Second) -->
        <div class="col-12 col-lg-6">
          <h5 class="mb-3">Available Appliances</h5>
          <p class="text-muted small mb-3">Select all appliances you have access to. Recipes will only use these appliances.</p>
          
        <% # Get current appliances (handle both hash and legacy formats)
           # Set defaults: stove, oven, kettle if appliances is empty
           default_appliances = %w[stove oven kettle]
           current_appliances = if @user.appliances.is_a?(Hash) && @user.appliances.any?
                                     @user.appliances
                                   else
                                     # Set defaults for new users or users with empty appliances
                                     User::STANDARD_APPLIANCES.each_with_object({}) do |a, h|
                                       h[a] = default_appliances.include?(a)
                                     end
                                   end %>

          <div class="d-flex flex-column gap-2">
            <% User::STANDARD_APPLIANCES.each do |appliance_key| %>
              <div class="form-check">
                <%= check_box_tag "user[appliances][#{appliance_key}]",
                                  1,
                                  current_appliances[appliance_key.to_s] == true || current_appliances[appliance_key.to_sym] == true,
                                  id: "user_appliances_#{appliance_key}",
                                  class: "form-check-input" %>
                <%= label_tag "user_appliances_#{appliance_key}",
                              appliance_key.tr("_", " ").split.map(&:capitalize).join(" "),
                              class: "form-check-label" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="border-top my-4"></div>

      <!-- Preferences Section (Free Text - Bottom) -->
      <div class="mb-4">
        <h5 class="mb-3">Cooking Preferences</h5>
        <p class="text-muted small mb-3">Any specific cooking preferences or dietary requirements (e.g., "always use sweetener instead of sugar").</p>
        <%= f.text_area :preferences,
                        rows: 3,
                        class: "form-control",
                        placeholder: "Example: I want to always use sweetener instead of cane sugar...",
                        style: "border-radius: 12px;" %>
      </div>

    <% end %>
    </div>
  </div>
</div>
